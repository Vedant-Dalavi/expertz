<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport" />
  <title><%= title %></title>
  <!-- General CSS Files -->
  <link rel="stylesheet" href="/css/app.min.css" />
  <link rel="stylesheet" href="/bundles/datatables/datatables.min.css" />
  <link rel="stylesheet" href="/bundles/datatables/DataTables-1.10.16/css/dataTables.bootstrap4.min.css" />
  <!-- Template CSS -->
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <!-- Custom style CSS -->
  <link rel="stylesheet" href="/css/custom.css" />
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
</head>

<body>
  <div class="loader"></div>
  <div id="app">
    <div class="main-wrapper main-wrapper-1">
      <%- include('../partial/navbar'); %>
      <%- include('../partial/sidebar'); %>

      <!-- Main Content -->
      <div class="main-content">
        <section class="section">
          <div class="section-body">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h4>Add Car Model</h4>
                  </div>
                  <div class="card-body">
                    <form id="car-model-form">
                      <div class="form-group">
                        <label for="service">Service</label>
                        <select id="service" class="form-control" required>
                          <option value="">Select a service</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="brand">Brand</label>
                        <select id="brand" class="form-control" required>
                          <option value="">Select a brand</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="carName">Car Name</label>
                        <select id="carName" class="form-control" required>
                          <option value="">Select a car</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="model">Model</label>
                        <input type="text" id="model" class="form-control" placeholder="Enter model" required>
                      </div>
                      <div class="form-group">
                        <label for="price">Price</label>
                        <input type="text" id="price" class="form-control" placeholder="Enter price" required>
                      </div>
                      <button type="submit" class="btn btn-primary">Add Car Model</button>
                    </form>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header">
                    <h4>Car Models Table</h4>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover" id="save-state" style="width: 100%">
                        <thead>
                          <tr>
                            <th>Service</th>
                            <th>Brand</th>
                            <th>Car Name</th>
                            <th>Model</th>
                            <th>Price</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
      <%- include('../partial/footer'); %>
      <%- include('../partial/site-settings.ejs'); %>
    </div>
  </div>
  <!-- General JS Scripts -->
  <script src="/js/app.min.js"></script>
  <!-- JS Libraries -->
  <script src="/bundles/datatables/datatables.min.js"></script>
  <script src="/bundles/datatables/DataTables-1.10.16/js/dataTables.bootstrap4.min.js"></script>
  <script src="/bundles/jquery-ui/jquery-ui.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var table = $('#save-state').DataTable({
        stateSave: true
      });

      // Fetch services and populate the service dropdown
      fetch('https://expterzbackend.onrender.com/api/v1/admin/get-carservice', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log('Services fetched from API:', data);

        if (data && data.success && Array.isArray(data.data)) {
          var serviceSelect = document.getElementById('service');
          serviceSelect.innerHTML = '<option value="">Select a service</option>';
          data.data.forEach(service => {
            if (service._id && service.serviceName) {
              var option = document.createElement('option');
              option.value = service._id;
              option.textContent = service.serviceName;
              serviceSelect.appendChild(option);
            }
          });

          // Populate table with data from the API
          populateTable(data.data);

          // Update brands dropdown based on selected service
          serviceSelect.addEventListener('change', function () {
            var selectedServiceId = this.value;
            var brandSelect = document.getElementById('brand');
            var carNameSelect = document.getElementById('carName');
            brandSelect.innerHTML = '<option value="">Select a brand</option>';
            carNameSelect.innerHTML = '<option value="">Select a car</option>';

            var selectedService = data.data.find(service => service._id === selectedServiceId);
            if (selectedService && selectedService.brands) {
              selectedService.brands.forEach(brand => {
                if (brand._id && brand.brand) {
                  var option = document.createElement('option');
                  option.value = brand._id;
                  option.textContent = brand.brand;
                  brandSelect.appendChild(option);
                }
              });

              // Update cars dropdown based on selected brand
              brandSelect.addEventListener('change', function () {
                var selectedBrandId = this.value;
                carNameSelect.innerHTML = '<option value="">Select a car</option>';

                var selectedBrand = selectedService.brands.find(brand => brand._id === selectedBrandId);
                if (selectedBrand && selectedBrand.cars) {
                  selectedBrand.cars.forEach(car => {
                    if (car._id && car.carName) {
                      var option = document.createElement('option');
                      option.value = car._id;
                      option.textContent = car.carName;
                      carNameSelect.appendChild(option);
                    }
                  });
                }
              });
            }
          });
        } else {
          console.error('Invalid services data:', data);
          alert('Failed to load services: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error fetching services:', error);
        alert('Error fetching services: ' + error.message);
      });

      // Populate table with car models
      function populateTable(services) {
        services.forEach(service => {
          if (service.brands && Array.isArray(service.brands)) {
            service.brands.forEach(brand => {
              if (brand.cars && Array.isArray(brand.cars)) {
                brand.cars.forEach(car => {
                  if (car.models && Array.isArray(car.models)) {
                    car.models.forEach(model => {
                      table.row.add([
                        service.serviceName, // Service Name
                        brand.brand, // Brand Name
                        car.carName,
                        model.model,
                        model.price,
                        `<button class="btn btn-warning edit-button">Edit</button>
                         <button class="btn btn-danger delete-button">Delete</button>`
                      ]).draw(false);
                    });
                  }
                });
              }
            });
          }
        });
      }

      // Handle form submission
      document.getElementById('car-model-form').addEventListener('submit', function (e) {
        e.preventDefault();

        var serviceId = document.getElementById('service').value;
        var brandId = document.getElementById('brand').value;
        var carId = document.getElementById('carName').value; // Get selected car ID
        var model = document.getElementById('model').value;
        var price = document.getElementById('price').value;

        var newCarModel = {
          serviceId: serviceId,
          brandId: brandId,
          carId: carId, // Send the car ID
          modelDetail: {
            model: model,
            price: price
          }
        };

        console.log('New car model to be added:', newCarModel);

        fetch('https://expterzbackend.onrender.com/api/v1/admin/get-carservice', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newCarModel)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          console.log('Response from API:', data);
          if (data.success) {
            table.row.add([
              document.querySelector('#service option:checked').textContent,
              document.querySelector('#brand option:checked').textContent,
              document.querySelector('#carName option:checked').textContent,
              model,
              price,
              `<button class="btn btn-warning edit-button">Edit</button>
               <button class="btn btn-danger delete-button">Delete</button>`
            ]).draw(false);

            document.getElementById('car-model-form').reset();
          } else {
            alert('Failed to add car model: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error adding car model:', error);
          alert('Error adding car model: ' + error.message);
        });
      });

      // Handle row edit and delete
      $('#save-state tbody').on('click', 'button.edit-button', function () {
        var row = table.row($(this).parents('tr'));
        var data = row.data();
        var newBrand = prompt("Edit Brand:", data[1]);
        if (newBrand != null) {
          data[1] = newBrand;
          row.data(data).draw();
        }
      });

      $('#save-state tbody').on('click', 'button.delete-button', function () {
        var row = table.row($(this).parents('tr'));
        var data = row.data();
        if (confirm(`Are you sure you want to delete car model: ${data[2]}?`)) {
          row.remove().draw();
        }
      });
    });
  </script>

  <!-- Template JS File -->
  <script src="/js/scripts.js"></script>
  <!-- Custom JS File -->
  <script src="/js/custom.js"></script>
</body>
</html>
